<!DOCTYPE html>
<html lang="en">
<head>
<title>Coverage</title>
<meta charset="utf-8"/>
<style>
@media screen{
    html {background-color: #FFFFF0;}
body {
    font-size: 16px;
    font-family : Verdana, "Bitstream Vera Sans", "DejaVu Sans", Tahoma, Geneva, Arial, Sans-serif;
    margin: 1em;
}
th, td {padding: 5px 10px;}
th {text-align: left;}
h1, h2, h3, h4, h5, h6 {color: #424242;}
h1 {font-size: 22px;}
h2 {font-size: 18px; margin-top: 2em; margin-bottom:0.3em;}
tbody tr:nth-child(even) {background-color: #F0F0F0;}
tbody tr:nth-child(odd) {background-color: #FAFAFA;}
th {background-color: #E6E6E6;color: #424242;}
table {border: silver 1px solid; font-size: 14px;font-family: APLFont, monospace;}
code , code a {font-size: 14px; font-family: APLFont, monospace;}
code.header {
    font-size: 16px; 
    font-family: APLFont, monospace; 
    margin: 1.5em 0.5em 0 0.5em; 
    padding:0;
    display: block;
}
div.code-block {
    border: 1px silver dashed;
    background-color: #F2F2F2;
    display: block;
    margin: 0.5em 0.5em 0.5em 0.5em;
    padding: 0.5em;
}
div.code-block.missing {
    background-color: #fa605254;
}
div.code-block code {display: block; white-space: pre-wrap; margin:0; padding:0; word-wrap: break-word;}
.emphasize { font-weight: 800;}
ul li, ol li {margin: 0.7em 0.2em;}
.float-right {float:right;}
.no-underline {    text-decoration :none;}
.top-links {font-size:20px; padding-left: 0.6em;}
.align-right {text-align: right;}
#footer hr {margin-top:1.5em;}
#footer p {margin-top:5px; padding-top:0; font-size: 9px;}
@font-face {
        font-family: "APLFont";
    src:
        local("APL385 Unicode"),
        url("https://misc.aplteam.com/apl385.ttf") format("truetype");
}
.info {border: 1px silver dashed; background-color: #F2F2F2;margin: 0.5em; padding: 0.5em;}
}
@media print{@page {size: portrait}
@page {
    margin: 1cm 1cm 1cm 1.75cm;
    @bottom-right {
        content: counter(page) " / " counter(pages);
  }
}
body {
    font: 12pt "Times New Roman", Times, serif;
    line-height: 1.2;
     /* CSS3 filter, at the moment Webkit only. Prefix it for future implementations */
    -webkit-filter: grayscale(100%);
    filter: grayscale(100%); /* future-proof */
}
h1 {font-size: 18pt;}
h2 {font-size: 16pt; margin-top: 10pt; margin-bottom: 3pt;}
th, td {padding: 2pt 3pt;}
th {text-align: left;background-color: #DBDBDB;}
tbody tr:nth-child(odd) {background-color: #EDEDED;}
table {
    color-adjust: exact !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    font-size: 8pt;
    font-family: APLFont, monospace;
}
div.keep-together {break-inside: avoid; break-before:auto;}
table {border: silver 1pt solid;}
code , code a {font-size: 8pt; font-family: APLFont, monospace;}
code.header {
    font-size: 8pt;
    font-family: APLFont, monospace;
    margin: 7pt 3pt 0 10pt;
    padding:0;
    display: block;
}
div.code-block {
    border: 1pt silver dashed;
    background-color: #F2F2F2;
    display: block;
    margin: 4pt 4pt 4pt 4pt;
    padding: 4pt;
}
div.code-block code {display: block; white-space: pre-wrap; margin:0; padding:0; word-wrap: break-word;}
.emphasize { font-weight: 800;}
a {text-decoration: none;color: black;}
ul li, ol li {margin: 8pt 3pt;}
.no-print {display:none;}
.align-right {text-align: right;}
#footer hr {margin-top:1.5em;}
#footer p {margin-top:5pt; padding-top:0; font-size: 6pt;}
@font-face {
        font-family: "APLFont";
    src:
        local("APL385 Unicode"),
        url("https://misc.aplteam.com/apl385.ttf") format("truetype");
}
.info {border: 1px silver dashed; background-color: #F2F2F2;margin: 8px; padding: 8px;}
}
</style>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jq-3.6.0/dt-1.11.2/b-2.0.0/b-print-2.0.0/fh-3.1.9/r-2.2.9/datatables.min.css"/>
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/jq-3.6.0/dt-1.11.2/b-2.0.0/b-print-2.0.0/fh-3.1.9/r-2.2.9/datatables.min.js"></script>
</head>
<body>
<h1 id="top">Coverage Report</h1>
<p>Watched: 23 fns/opr within <code>#.HandleError.HandleError</code></p>
<p>The test suite was executed once:</p>
<table>
<thead>
<tr><th>Executed at</th><th>APLVersion</th><th>Memory (MB)</th></tr>
</thead>
<tbody>
<tr><td>2025-04-08 18:38:09</td><td>Windows-64 ⋄ 19.0.51432.0 ⋄ W ⋄ Development ⋄ Unicode</td><td>114</td></tr>
</tbody>
</table>
<p>Overall 87% of the testable code is covered.</p>
<p>(Comment lines, empty lines, all <code>:End</code>* lines etc. are ignored)</p>
<p>12 of the fns/opr are 100% covered.</p>
<div id="partly-covered" class="keep-together">
<table id="percent">
<thead>
<tr><th style="text-align:left;">Function/Operator</th><th style="text-align:left;">Lines not executed</th><th style="text-align:left;">Coverage</th><th style="text-align:right;">≢</th></tr>
</thead>
<tbody>
<tr><td><a href="#listing_1" title="Link to listing">#.HandleError.HandleError.WriteWindowsLog_</a></td><td>10←≢15-18,20-22,24-26</td><td>47</td><td>19</td></tr>
<tr><td><a href="#listing_2" title="Link to listing">#.HandleError.HandleError.Version</a></td><td>4, 10</td><td>60</td><td>5</td></tr>
<tr><td><a href="#listing_3" title="Link to listing">#.HandleError.HandleError.SaveCrash</a></td><td>6, 7, 8</td><td>63</td><td>8</td></tr>
<tr><td><a href="#listing_4" title="Link to listing">#.HandleError.HandleError.WriteHtmlFile</a></td><td>6, 7, 8</td><td>63</td><td>8</td></tr>
<tr><td><a href="#listing_5" title="Link to listing">#.HandleError.HandleError.Process</a></td><td>8←≢38,45-47,49,52-53,56</td><td>80</td><td>40</td></tr>
<tr><td><a href="#listing_6" title="Link to listing">#.HandleError.HandleError.ReportErrorToWindowsLog</a></td><td>6</td><td>83</td><td>6</td></tr>
<tr><td><a href="#listing_7" title="Link to listing">#.HandleError.HandleError.WriteToLogFile</a></td><td>9, 16</td><td>83</td><td>12</td></tr>
<tr><td><a href="#listing_8" title="Link to listing">#.HandleError.HandleError.CheckErrorFolder</a></td><td>12, 24</td><td>88</td><td>17</td></tr>
<tr><td><a href="#listing_9" title="Link to listing">#.HandleError.HandleError.ExecuteCustomFns</a></td><td>9</td><td>88</td><td>8</td></tr>
<tr><td><a href="#listing_10" title="Link to listing">#.HandleError.HandleError.SaveErrorWorkspace</a></td><td>9</td><td>91</td><td>11</td></tr>
<tr><td><a href="#listing_11" title="Link to listing">#.HandleError.HandleError.AssembleHTML</a></td><td>48</td><td>98</td><td>49</td></tr>
<tr class="fullyCovered"><td><a href="#listing_12" title="Link to listing">#.HandleError.HandleError.CR</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_13" title="Link to listing">#.HandleError.HandleError.CreateCrashNamespace</a></td><td></td><td>100</td><td>13</td></tr>
<tr class="fullyCovered"><td><a href="#listing_14" title="Link to listing">#.HandleError.HandleError.CreateFilename</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_15" title="Link to listing">#.HandleError.HandleError.CreateParms</a></td><td></td><td>100</td><td>22</td></tr>
<tr class="fullyCovered"><td><a href="#listing_16" title="Link to listing">#.HandleError.HandleError.ExchangeHtmlChars</a></td><td></td><td>100</td><td>9</td></tr>
<tr class="fullyCovered"><td><a href="#listing_17" title="Link to listing">#.HandleError.HandleError.Init</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_18" title="Link to listing">#.HandleError.HandleError.MarkupAsTableRow</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_19" title="Link to listing">#.HandleError.HandleError.PrintErrorToSession</a></td><td></td><td>100</td><td>2</td></tr>
<tr class="fullyCovered"><td><a href="#listing_20" title="Link to listing">#.HandleError.HandleError.Public</a></td><td></td><td>100</td><td>7</td></tr>
<tr class="fullyCovered"><td><a href="#listing_21" title="Link to listing">#.HandleError.HandleError.SaveVisibleVars</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_22" title="Link to listing">#.HandleError.HandleError.SetTrap</a></td><td></td><td>100</td><td>14</td></tr>
<tr class="fullyCovered"><td><a href="#listing_23" title="Link to listing">#.HandleError.HandleError.WriteToWindowsEvents</a></td><td></td><td>100</td><td>9</td></tr>
</tbody>
</table>
</div>
<script>
$(document).ready(function() {
    var oTable;
    oTable = $("#percent").DataTable( {
        paging:   false,
        ordering: true,
        info:     true,
        fixedHeader: true,
        order: [2,"asc"],
        dom: "Bft",
        drawCallback: function( settings ) {
             var api = this.api();
             $('.header[id^="listing_"]').next().addBack().css("display","none");
             api.rows( {page:"current"} ).data().each(function(data){
              id = data[0];
              id = id.match(/"(\#.*?)"/);
              if (id){$(id[1]).next().addBack().css("display","block");}
             })
        },      
        buttons: [
        {
            text: "Partly covered (11)",
            titleAttr: "50%",
            className: "active",
            action: function ( e, dt, node, config ) {
                var text = this.text();
                var search = "^(?!(0%|100%)).*";
                oTable.column(2)
                    .search(search,true,false,false)
                    .draw();
                $(".dt-buttons button").removeClass("active");
                this.active( true );
            }
        },
        {
            text: "Uncovered (0)",
            titleAttr: "0%",
            className: "active",
            action: function ( e, dt, node, config ) {
                var text = this.text();
                var search = "^0%";
                oTable.column(2)
                    .search(search,true,false,false)
                    .draw();
                $(".dt-buttons button").removeClass("active");
                this.active( true );
            }
        },
        {
            text: "Fully covered (12)",
            titleAttr: "100%",
            className: "active",
            action: function ( e, dt, node, config ) {
                var text = this.text();
                var search = "100%";
                oTable.column(2)
                    .search(search,true,false,false)
                    .draw();
                $(".dt-buttons button").removeClass("active");
                this.active( true );
            }
        },
        {
            text: "All (23)",
            titleAttr: "all",
            className: "active",
            action: function ( e, dt, node, config ) {
                var text = this.text();
                var search = ".";
                oTable.column(2)
                    .search(search,true,false,false)
                    .draw();
                $(".dt-buttons button").removeClass("active");
                this.active( true );
            }
        },
    ],
 
        columnDefs: [
            {className: "align-right", targets: [2,3]
            },
            {
                render: function ( data, type, row, meta ) {
                            return data+"%" ;        
                        },
                targets: 2
            }
        ]             
    } );
    oTable.button(0).trigger();

} );    
</script>
<h2>Listings</h2>
<code class="header" id="listing_1">#.HandleError.HandleError.WriteWindowsLog_ &mdash; 47%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {r}←WriteWindowsLog_(source type message)</code>
<code> [1]  ⍝ This function writes to the Windows Event Log.</code>
<code> [2]  ⍝ "message" must either be a string or a vector of strings.</code>
<code> [3]  ⍝ "type"</code>
<code> [4]   ⎕ML←1</code>
<code> [5]   r←⍬</code>
<code> [6]   ⎕USING←'System,system.dll' 'System.Diagnostics,system.dll'</code>
<code> [7]      ⍝ Should check the source/log exist.</code>
<code> [8]   eventLog←⎕NEW EventLog</code>
<code> [9]   eventLog.Source←source</code>
<code> [10]  sep←⎕UCS 10</code>
<code> [11]  buffer←¯1↓⊃,/message,¨sep</code>
<code> [12]  eventLog.WriteEntry buffer type</code>
<code> [13]  ∇</code>
<code> [14] </code>
<code class="emphasize">→[15]  ∇ html←ExchangeHtmlChars html;b</code>
<code class="emphasize">→[16]  :If 0&lt;+/b←html='&amp;'</code>
<code class="emphasize">→[17]      (b/html)←⊂'&amp;amp;'</code>
<code class="emphasize">→[18]      html←∊html</code>
<code> [19]  :EndIf</code>
<code class="emphasize">→[20]  :If 0&lt;+/b←html='&lt;'</code>
<code class="emphasize">→[21]      (b/html)←⊂'&amp;lt;'</code>
<code class="emphasize">→[22]      html←∊html</code>
<code> [23]  :EndIf</code>
<code class="emphasize">→[24]  :If 0&lt;+/b←html='&gt;'</code>
<code class="emphasize">→[25]      (b/html)←⊂'&amp;gt;'</code>
<code class="emphasize">→[26]      html←∊html</code>
<code> [27]  :EndIf</code>
</div>
<code class="header" id="listing_2">#.HandleError.HandleError.Version &mdash; 60%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←Version</code>
<code> [1]   ⍝ Returns the version number from `TatinVars` if possible.</code>
<code> [2]   ⍝ See also `History`</code>
<code> [3]   :If 0&lt;⎕NC'TatinVars.CONFIG'</code>
<code class="emphasize">→[4]       r←(⎕JSON⍠('Dialect' 'JSON5')⊢TatinVars.CONFIG).version</code>
<code> [5]   :ElseIf 0&lt;##.⎕NC'TatinVars.CONFIG'</code>
<code> [6]       r←(⎕JSON⍠('Dialect' 'JSON5')⊢##.TatinVars.CONFIG).version</code>
<code> [7]   :Else</code>
<code> [8]   ⍝ When a script was not loaded with Tatin, there will be no namespace `TatinVars`.</code>
<code> [9]   ⍝ In such cases we cannot provide a version number, so we return just ''.</code>
<code class="emphasize">→[10]      r←''</code>
<code> [11]  :EndIf</code>
</div>
<code class="header" id="listing_3">#.HandleError.HandleError.SaveCrash &mdash; 63%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {r}←SaveCrash(filename crash parms)</code>
<code> [1]   :If parms.saveCrash</code>
<code> [2]       :Trap (parms.trapInternalErrors)/0</code>
<code> [3]           tno←filename ⎕FCREATE 0</code>
<code> [4]           crash ⎕FAPPEND tno  ⍝ Might fail with a WS FULL</code>
<code> [5]       :Else</code>
<code class="emphasize">→[6]           :Trap 0</code>
<code class="emphasize">→[7]               qdmx←⎕DMX</code>
<code class="emphasize">→[8]               qdmx.DM ⎕FAPPEND tno</code>
<code> [9]           :EndTrap</code>
<code> [10]      :EndTrap</code>
<code> [11]      :Trap 0 ⋄ ⎕FUNTIE tno ⋄ :EndTrap</code>
<code> [12]  :EndIf</code>
</div>
<code class="header" id="listing_4">#.HandleError.HandleError.WriteHtmlFile &mdash; 63%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {html}←WriteHtmlFile(parms crash filename)</code>
<code> [1]   :If parms.createHTML</code>
<code> [2]       html←AssembleHTML parms crash</code>
<code> [3]       :Trap (parms.trapInternalErrors)/0</code>
<code> [4]           (⊂html)⎕NPUT(filename,'.html')1</code>
<code> [5]       :Else</code>
<code class="emphasize">→[6]           :Trap parms.trapInternalErrors/0</code>
<code class="emphasize">→[7]               :If APLTreeUtils2.IsDevelopment</code>
<code class="emphasize">→[8]                   11 ⎕SIGNAL'Writing HTML file failed: ',1⊃parms.LastError</code>
<code> [9]               :EndIf</code>
<code> [10]          :EndTrap</code>
<code> [11]      :EndTrap</code>
<code> [12]  :Else</code>
<code> [13]      html←''</code>
<code> [14]  :EndIf</code>
</div>
<code class="header" id="listing_5">#.HandleError.HandleError.Process &mdash; 80%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {r}←{signal}Process parms</code>
<code> [1]  ⍝ `⎕OFF`s in runtime or if `enforceOff` is 1 but executes `→` otherwise.\\</code>
<code> [2]  ⍝ In case you need to save the name of the error WS you must specify a parameter space. `HandleError` will</code>
<code> [3]  ⍝ inject a variable `∆ERROR_WS` into the parameter space.\\</code>
<code> [4]  ⍝ All actions `Process` will execute are performed under error trapping, so it should never fail.\\</code>
<code> [5]  ⍝ `signal`: if specified this overwrites `parms.signal`; this is for test cases only.</code>
<code> [6]   r←⍬</code>
<code> [7]   :Hold 'HandleError.Process'</code>
<code> [8]       ⎕IO←1 ⋄ ⎕ML←1</code>
<code> [9]       qdmx←⎕DMX</code>
<code> [10]      TRAP←⎕TRAP                                    ⍝ Remember old setting (for reporting)</code>
<code> [11]      ⎕TRAP←(0 1000)'C' '→∆End'                     ⍝ Make sure that it does not crash itself</code>
<code> [12]      parms←⍎⍣((0≠≢parms)∧(⎕DR parms)∊320 160 80 82)⊣parms     ⍝ Convert name into reference</code>
<code> [13]      :If 9≠⎕NC'parms'</code>
<code> [14]      :OrIf 0=≢parms</code>
<code> [15]          parms←CreateParms</code>
<code> [16]      :EndIf</code>
<code> [17]      :If 0&lt;⎕NC'signal'</code>
<code> [18]          parms.signal←signal</code>
<code> [19]      :EndIf</code>
<code> [20]      parms.(LastError LastErrorNumber)←qdmx.(DM EN)</code>
<code> [21]      parms.(EN ENX EM Message)←qdmx.(EN ENX EM Message)</code>
<code> [22]      CheckErrorFolder parms</code>
<code> [23]      crash←CreateCrashNamespace parms TRAP</code>
<code> [24]      filename←CreateFilename parms.errorFolder</code>
<code> [25]      parms.∆ERROR_WS←filename</code>
<code> [26]      parms.crashFilename←filename</code>
<code> [27]      {}{0 ⎕TKILL ⍵}⍣parms.killThreads⊣⎕TNUMS~⎕TID   ⍝ Try to kill all threads but itself and the main thread</code>
<code> [28]      :Trap 0</code>
<code> [29]          WriteHtmlFile parms crash filename</code>
<code> [30]      :EndTrap</code>
<code> [31]      :Trap 0</code>
<code> [32]          WriteToLogFile parms</code>
<code> [33]      :EndTrap</code>
<code> [34]      ⎕DL 0.2</code>
<code> [35]      :Trap 0</code>
<code> [36]          crash←SaveErrorWorkspace filename parms crash</code>
<code> [37]      :Else</code>
<code class="emphasize">→[38]          crash←⎕NS''</code>
<code> [39]      :EndTrap</code>
<code> [40]      SaveCrash filename crash parms</code>
<code> [41]      WriteToWindowsEvents parms</code>
<code> [42]      ExecuteCustomFns parms</code>
<code> [43]      :If 0≠parms.signal</code>
<code> [44]          ⎕SIGNAL parms.signal</code>
<code class="emphasize">→[45]      :ElseIf parms.off</code>
<code class="emphasize">→[46]          :If APLTreeUtils2.IsDevelopment∧0=parms.enforceOff</code>
<code class="emphasize">→[47]              PrintErrorToSession 1⊃parms.LastError</code>
<code> [48]          :Else</code>
<code class="emphasize">→[49]              ⎕OFF parms.returnCode</code>
<code> [50]          :EndIf</code>
<code> [51]      :Else</code>
<code class="emphasize">→[52]          :If APLTreeUtils2.IsDevelopment∧0=parms.enforceOff</code>
<code class="emphasize">→[53]              PrintErrorToSession 1⊃parms.LastError</code>
<code> [54]          :EndIf</code>
<code> [55]      :EndIf</code>
<code class="emphasize">→[56] ∆End:⎕TRAP←TRAP</code>
<code> [57]  :EndHold</code>
</div>
<code class="header" id="listing_6">#.HandleError.HandleError.ReportErrorToWindowsLog &mdash; 83%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {r}←ReportErrorToWindowsLog(appName message)</code>
<code> [1]  ⍝ Reports an error to the Windows Event Log, by default to source="APL".\\</code>
<code> [2]  ⍝ Note that the Dyalog bridge DLLs are required for this to work.</code>
<code> [3]   r←⍬</code>
<code> [4]   ⎕USING←'System,system.dll' 'System.Diagnostics,system.dll'</code>
<code> [5]   :If 0=≢appName</code>
<code class="emphasize">→[6]       appName←'APL'</code>
<code> [7]   :EndIf</code>
<code> [8]   message←⊆message</code>
<code> [9]   WriteWindowsLog_ appName EventLogEntryType.Error message</code>
<code> [10] ⍝Done</code>
</div>
<code class="header" id="listing_7">#.HandleError.HandleError.WriteToLogFile &mdash; 83%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  WriteToLogFile parms</code>
<code> [1]   :If 0≠≢parms.logFunction</code>
<code> [2]       :Trap (parms.trapInternalErrors)/0</code>
<code> [3]           :If '.'∊parms.logFunction</code>
<code> [4]               fns←⍎parms.logFunction</code>
<code> [5]           :Else</code>
<code> [6]               :If ⍬≢parms.logFunctionParent</code>
<code> [7]                   fns←parms.logFunctionParent⍎parms.logFunction</code>
<code> [8]               :Else</code>
<code class="emphasize">→[9]                   'Cannot find the log function'⎕SIGNAL 6</code>
<code> [10]              :EndIf</code>
<code> [11]          :EndIf</code>
<code> [12]          fns'*** Error'</code>
<code> [13]          fns'Error number=',⍕parms.LastErrorNumber</code>
<code> [14]          fns parms.LastError</code>
<code> [15]          :If 0≠≢parms.addToMsg</code>
<code class="emphasize">→[16]              fns parms.addToMsg</code>
<code> [17]          :EndIf</code>
<code> [18]      :Else</code>
<code> [19]           ⍝ Useful to realize in the tracer that something went wrong</code>
<code> [20]      :EndTrap</code>
<code> [21]  :EndIf</code>
</div>
<code class="header" id="listing_8">#.HandleError.HandleError.CheckErrorFolder &mdash; 88%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {r}←CheckErrorFolder parms</code>
<code> [1]   r←⍬</code>
<code> [2]   :If 0=≢parms.errorFolder</code>
<code> [3]       :If 0=≢wsid←⎕WSID</code>
<code> [4]           ⎕WSID←'Error-WS'</code>
<code> [5]       :EndIf</code>
<code> [6]       :If 0=≢buff←2⊃⎕NPARTS wsid</code>
<code> [7]           buff←2⊃⎕NPARTS{'"'∊⍵:1↓⍵/⍨1=+\'"'=⍵ ⋄ ⍵↑⍨¯1+⍵⍳' '}2 ⎕NQ'#' 'GetCommandLine' ⍝ Probably a stand-alone EXE</code>
<code> [8]       :EndIf</code>
<code> [9]       :If 'Win'≡APLTreeUtils2.GetOperatingSystem ⍬</code>
<code> [10]          parms.errorFolder←(⊃⎕CMD'ECHO %LOCALAPPDATA%'),'/',buff,'\Errors'</code>
<code> [11]      :Else</code>
<code class="emphasize">→[12]          parms.errorFolder←FilesAndDirs.PWD,'/Errors'</code>
<code> [13]      :EndIf</code>
<code> [14]  :EndIf</code>
<code> [15]  parms.errorFolder←{(-(¯1↑⍵)∊'/\')↓⍵}FilesAndDirs.NormalizePath parms.errorFolder</code>
<code> [16]  :If 0=+/'/\'∊parms.errorFolder</code>
<code> [17]      parms.errorFolder←FilesAndDirs.NormalizePath FilesAndDirs.PWD,'/',parms.errorFolder</code>
<code> [18]  :EndIf</code>
<code> [19]  :If 0=⎕NEXISTS parms.errorFolder</code>
<code> [20]  :AndIf parms.checkErrorFolder</code>
<code> [21]      :If 'Win'≡APLTreeUtils2.GetOperatingSystem ⍬</code>
<code> [22]          FilesAndDirs.MkDir parms.errorFolder</code>
<code> [23]      :Else</code>
<code class="emphasize">→[24]          ⎕SH'mkdir -p "',parms.errorFolder,'"'</code>
<code> [25]      :EndIf</code>
<code> [26]  :EndIf</code>
</div>
<code class="header" id="listing_9">#.HandleError.HandleError.ExecuteCustomFns &mdash; 88%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ExecuteCustomFns parms</code>
<code> [1]   :If 0≠≢parms.customFns</code>
<code> [2]       :Trap (parms.trapInternalErrors)/0</code>
<code> [3]           :If '.'∊parms.customFns</code>
<code> [4]               fns←⍎parms.customFns</code>
<code> [5]           :Else</code>
<code> [6]               :If ⍬≢parms.customFnsParent</code>
<code> [7]                   fns←parms.customFnsParent⍎parms.customFns</code>
<code> [8]               :Else</code>
<code class="emphasize">→[9]                   'Cannot find the custom function'⎕SIGNAL 6</code>
<code> [10]              :EndIf</code>
<code> [11]          :EndIf</code>
<code> [12]          fns parms</code>
<code> [13]      :Else</code>
<code> [14]         ⍝ Useful to realize in the tracer that something went wrong</code>
<code> [15]      :EndTrap</code>
<code> [16]  :EndIf</code>
</div>
<code class="header" id="listing_10">#.HandleError.HandleError.SaveErrorWorkspace &mdash; 91%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {crash}←SaveErrorWorkspace(filename parms crash)</code>
<code> [1]   :If parms.saveErrorWS</code>
<code> [2]       wsid←⎕WSID</code>
<code> [3]       ⎕WSID←filename</code>
<code> [4]       lx←⎕LX</code>
<code> [5]       ⎕LX←'⎕TRAP←0 ''S'' ⍝',⎕LX</code>
<code> [6]       :Trap parms.trapSaveWSID/0</code>
<code> [7]           ⎕SAVE ⎕WSID</code>
<code> [8]       :Else</code>
<code class="emphasize">→[9]           crash.SaveFailed←qdmx.Message</code>
<code> [10]      :EndTrap</code>
<code> [11]      ⎕WSID←wsid       ⍝ Potentially important (for example when running test cases)</code>
<code> [12]      ⎕LX←lx</code>
<code> [13]  :EndIf</code>
<code> [14] ∆End:</code>
</div>
<code class="header" id="listing_11">#.HandleError.HandleError.AssembleHTML &mdash; 98%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  html←AssembleHTML(parms crash)</code>
<code> [1]   html←'&lt;!DOCTYPE html&gt;',CR</code>
<code> [2]   html,←'&lt;html lang="en"&gt;',CR</code>
<code> [3]   html,←'&lt;head&gt;',CR</code>
<code> [4]   html,←'  &lt;meta charset="utf-8"&gt;',CR</code>
<code> [5]   html,←'  &lt;title&gt;',('/'APLTreeUtils2.Last filename),'&lt;/title&gt;',CR</code>
<code> [6]   html,←'  &lt;style media="screen" type="text/css"&gt;',CR</code>
<code> [7]   html,←'    pre {',CR</code>
<code> [8]   html,←'   font-family: "APL385 Unicode"; font-size: 14px;',CR</code>
<code> [9]   html,←'   }',CR</code>
<code> [10]  html,←'   h1 {',CR</code>
<code> [11]  html,←'   font-family: "Courier New";',CR</code>
<code> [12]  html,←'   }',CR</code>
<code> [13]  html,←'   table#apl {',CR</code>
<code> [14]  html,←'   font-family: "APL385 Unicode"; font-size: 14px;',CR</code>
<code> [15]  html,←'   }',CR</code>
<code> [16]  html,←'  &lt;/style&gt;',CR</code>
<code> [17]  html,←'&lt;/head&gt;',CR</code>
<code> [18]  html,←'&lt;body&gt;',CR</code>
<code> [19]  html,←'  &lt;h1&gt;',('/'APLTreeUtils2.Last filename),'&lt;/h1&gt;',CR</code>
<code> [20]  html,←'  &lt;table id="apl"&gt;'</code>
<code> [21]  html,←'  Version'MarkupAsTableRow⍕'#'⎕WG'APLVersion'</code>
<code> [22]  html,←'  ⎕WSID'MarkupAsTableRow⍕{'/'APLTreeUtils2.Last ⍵ ⋄ ⍵}⍣('/'∊crash.WSID)⊣1↓' ',crash.WSID  ⍝ Enforce ⎕DR 80/82 with 1↓' ',</code>
<code> [23]  html,←'  ⎕IO'MarkupAsTableRow⍕⎕IO</code>
<code> [24]  html,←'  ⎕ML'MarkupAsTableRow⍕⎕ML</code>
<code> [25]  html,←'  ⎕WA'MarkupAsTableRow⍕⎕WA</code>
<code> [26]  html,←'  ⎕TNUMS'MarkupAsTableRow{0=≢⍵:⍵ ⋄ ⊃{⍺,',',⍵}/⍕¨⍵}⎕TNUMS</code>
<code> [27]  html,←'  Category'MarkupAsTableRow crash.Category</code>
<code> [28]  html,←'  EM'MarkupAsTableRow crash.EM</code>
<code> [29]  html,←'  HelpURL'MarkupAsTableRow crash.HelpURL</code>
<code> [30]  html,←'  EN'MarkupAsTableRow⍕crash.EN</code>
<code> [31]  html,←'  ENX'MarkupAsTableRow⍕crash.ENX</code>
<code> [32]  html,←'  InternalLocation'MarkupAsTableRow⍕crash.InternalLocation</code>
<code> [33]  html,←'  OSError'MarkupAsTableRow⍕crash.OSError</code>
<code> [34]  html,←'  Current Dir'MarkupAsTableRow⍕crash.CurrentDir</code>
<code> [35]  html,←'  Command line'MarkupAsTableRow⍕crash.CommandLine</code>
<code> [36]  :If 0≠≢parms.addToMsg</code>
<code> [37]      html,←'  Added Msg'MarkupAsTableRow parms.addToMsg</code>
<code> [38]  :EndIf</code>
<code> [39]  html,←'  &lt;/table&gt;'</code>
<code> [40]  html,←'&lt;p&gt;&lt;b&gt;Stack:&lt;/b&gt;&lt;/p&gt;',CR</code>
<code> [41]  :If 0≠≢crash.XSI</code>
<code> [42]      html,←'&lt;pre&gt;',(⊃,/CR,¨crash.XSI,¨{'[',(⍕⍵),']'}¨crash.LC),CR,'&lt;/pre&gt;',CR</code>
<code> [43]  :EndIf</code>
<code> [44]  html,←'&lt;p&gt;&lt;b&gt;Error Message:&lt;/b&gt;&lt;/p&gt;',CR</code>
<code> [45]  :If 0≠≢crash.DM</code>
<code> [46]      html,←'&lt;pre&gt;',(ExchangeHtmlChars⊃,/CR,¨crash.DM),CR</code>
<code> [47]      :If 0&lt;≢crash.Message</code>
<code class="emphasize">→[48]          html,←crash.Message,CR</code>
<code> [49]      :EndIf</code>
<code> [50]      html,←'&lt;/pre&gt;',CR</code>
<code> [51]  :EndIf</code>
<code> [52]  html,←'&lt;/body&gt;',CR</code>
<code> [53]  html,←'&lt;/html&gt;',CR</code>
</div>
<code class="header" id="listing_12">#.HandleError.HandleError.CR &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←CR</code>
<code> [1]  r←⎕UCS 13</code>
</div>
<code class="header" id="listing_13">#.HandleError.HandleError.CreateCrashNamespace &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  crash←CreateCrashNamespace(parms Trap)</code>
<code> [1]   crash←⎕NS''</code>
<code> [2]   crash.(AN DM EN XSI LC WSID TID TNUMS)←⎕AN ⎕DM ⎕EN ⎕XSI ⎕LC ⎕WSID ⎕TID ⎕TNUMS</code>
<code> [3]   crash.WA←⎕WA</code>
<code> [4]   crash.Trap←Trap</code>
<code> [5]   crash.CurrentDir←FilesAndDirs.PWD</code>
<code> [6]   crash.CommandLine←2 ⎕NQ'#' 'GetCommandLine'</code>
<code> [7]   :Trap (parms.trapInternalErrors)/0</code>
<code> [8]       crash.(Category DM EM HelpURL EN ENX InternalLocation Message OSError)←qdmx.(Category DM EM HelpURL EN ENX InternalLocation Message OSError)</code>
<code> [9]       crash.(XSI LC)←1↓¨crash.(XSI LC)</code>
<code> [10]  :EndTrap</code>
<code> [11]  :If 0≠≢parms.addToMsg</code>
<code> [12]      crash.addedMsg←parms.addToMsg</code>
<code> [13]  :EndIf</code>
<code> [14]  :If parms.saveVars</code>
<code> [15]      crash←SaveVisibleVars crash</code>
<code> [16]  :EndIf</code>
</div>
<code class="header" id="listing_14">#.HandleError.HandleError.CreateFilename &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> CreateFilename←{</code>
<code> [1]      folder←⍵</code>
<code> [2]      folder,←((0≠≢folder)∧'/'≠¯1↑folder)/'/'</code>
<code> [3]      folder,({⍵↑⍨¯1+⍵⍳'.'}2⊃APLTreeUtils2.SplitPath crash.WSID),'_',14 0⍕100⊥6↑⎕TS}</code>
</div>
<code class="header" id="listing_15">#.HandleError.HandleError.CreateParms &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←CreateParms</code>
<code> [1]  ⍝ Returns a namespace with default values for the `HandleError` method</code>
<code> [2]  ⍝ | Parameter    | Description|</code>
<code> [3]  ⍝ | - | - |</code>
<code> [4]  ⍝ | `checkErrorFolder` | Boolean that defaults to 1. If this is 1 and the folder `errorFolder` does **not** exist&lt;&lt;br&gt;&gt;it will be created. |</code>
<code> [5]  ⍝ | `createHTML` | Boolean that defaults to 1. A 0 means that no HTML file will be created.|</code>
<code> [6]  ⍝ | `customFns`  | Fully qualified name of a monadic function to be executed by `Process`. Useful to send an email, for example. See also `customFnsParent`.|</code>
<code> [7]  ⍝ | `customFnsParent` | No default. May be a reference pointing to the parent of the `customFns`. Needed only in case the parent is a class instance since `logFunction` may use dottet syntax.|</code>
<code> [8]  ⍝ | `enforceOff` | Boolean that defaults to 0. With a 1 you can force `HandleError` to `⎕OFF` no matter whether it's a runtime EXE or not. Overwrites `off`. Mainly for test cases.|</code>
<code> [9]  ⍝ | `errorFolder`| Folder that keeps the component file (`crash`), the HTML page and the error WS. See below for rules.|</code>
<code> [10] ⍝ | `killThreads`| Boolean that defaults to 1, meaning that all threads that can be killed will be killed.|</code>
<code> [11] ⍝ | `logFunction`| Name of the logging function to be used. See also `logFnsParent`.|</code>
<code> [12] ⍝ | `logFnsParent` | No default. May be a reference pointing to the parent of `logFunction`. Needed only in case the parent is a class instance since `logFunction` may use dottet syntax.|</code>
<code> [13] ⍝ | `off`        | Boolean that defaults to 1 which makes `HandleError` execute `⎕OFF` with `returnCode` only in Runtime. A 0 suppresses this, executing `→` instead. See also `enforceOff`|</code>
<code> [14] ⍝ | `returnCode` | The return code passed on to `⎕OFF`.|</code>
<code> [15] ⍝ | `saveCrash`  | Boolean that defaults to 1.&lt;&lt;br&gt;&gt;A 0 suppresses the creation of `crash` &amp; a component file in which `crash` is saved.|</code>
<code> [16] ⍝ | `saveErrorWS`| Boolean that defaults to 1.&lt;&lt;br&gt;&gt;A 0 suppresses the creation of a crash workspace. There is no point in attempting&lt;&lt;br&gt;&gt;to save a WS in a multi-threaded application for example.|</code>
<code> [17] ⍝ | `saveVars`   | Boolean that defaults to 1.&lt;&lt;br&gt;&gt;Is ignored when `saveCrash` is 0. If 1 all visible variables are saved in a&lt;&lt;br&gt;&gt;sub namespace `Vars` within `crash`.|</code>
<code> [18] ⍝ | `signal`     | When `off` is 0 and `signal` is not 0 then `signal` is `⎕SIGNAL`led by `Process`.&lt;&lt;br&gt;&gt;This can be used for a restart attempt.|</code>
<code> [19] ⍝ | `trapInternalErrors` | By default all internal errors are trapped:&lt;&lt;br&gt;&gt;`Process` should never crash an application.|</code>
<code> [20] ⍝ | `trapSaveWSID`       | Boolean that defaults to 1. Makes sure that the `⎕SAVE` statement is guarded.&lt;&lt;br&gt;&gt;Useful to trace through it without a problem in versions prior to 14.1.|</code>
<code> [21] ⍝ | `windowsEventSource` | Name of the Windows Event Log to write to. Ignored when empty.|</code>
<code> [22] ⍝ | `addToMsg`           | Will be added to the log file as well as the Windows Event Log messages.&lt;&lt;br&gt;&gt;Mainly for test cases.|\\</code>
<code> [23] ⍝ Since version 2.2.0 `errorFolder` defaults to an empty vector. Assuming that the WS or the stand-alone EXE have the name "Foo" the following rules hold true:</code>
<code> [24] ⍝ * If `errorFolder` is empty then it defaults to "%LOCALAPPDATA%/Foo/Errors" under Windows and "Errors/" in the current</code>
<code> [25] ⍝   directory otherwise.</code>
<code> [26] ⍝ * If `errorFolder` is "Errors/" then this folder will be expected in the current directory.</code>
<code> [27] ⍝ * If `errorFolder` is an absolute path it is assumed that the last part is the folder that shall hold the crash files.\\</code>
<code> [28] ⍝ In all three instances if the folder in question does not exist but `checkErrorFolder` is 1 the folder will be created.</code>
<code> [29]  :Access Public Shared</code>
<code> [30]  ⎕IO←0 ⋄ ⎕ML←3</code>
<code> [31]  r←⎕NS''</code>
<code> [32]  r.⎕FX'r←∆List;⎕IO' '⍝ List all variables and possible references in this namespace' '⎕IO←0' 'r←{⍵,[0.5]⍎¨⍵}'' ''~¨⍨↓⎕NL 2 9'</code>
<code> [33]  r.checkErrorFolder←1</code>
<code> [34]  r.createHTML←1</code>
<code> [35]  r.customFns←''</code>
<code> [36]  r.customFnsParent←⍬</code>
<code> [37]  r.enforceOff←0</code>
<code> [38]  r.errorFolder←''</code>
<code> [39]  r.killThreads←1</code>
<code> [40]  r.logFunction←''</code>
<code> [41]  r.logFunctionParent←⍬</code>
<code> [42]  r.off←1</code>
<code> [43]  r.returnCode←1</code>
<code> [44]  r.saveCrash←1</code>
<code> [45]  r.saveErrorWS←1</code>
<code> [46]  r.saveVars←1</code>
<code> [47]  r.signal←0</code>
<code> [48]  r.trapInternalErrors←1</code>
<code> [49]  r.trapSaveWSID←1</code>
<code> [50]  r.windowsEventSource←''</code>
<code> [51]  r.addToMsg←''</code>
<code> [52] ⍝Done</code>
</div>
<code class="header" id="listing_16">#.HandleError.HandleError.ExchangeHtmlChars &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  html←ExchangeHtmlChars html</code>
<code> [1]   :If 0&lt;+/b←html='&amp;'</code>
<code> [2]       (b/html)←⊂'&amp;amp;'</code>
<code> [3]       html←∊html</code>
<code> [4]   :EndIf</code>
<code> [5]   :If 0&lt;+/b←html='&lt;'</code>
<code> [6]       (b/html)←⊂'&amp;lt;'</code>
<code> [7]       html←∊html</code>
<code> [8]   :EndIf</code>
<code> [9]   :If 0&lt;+/b←html='&gt;'</code>
<code> [10]      (b/html)←⊂'&amp;gt;'</code>
<code> [11]      html←∊html</code>
<code> [12]  :EndIf</code>
</div>
<code class="header" id="listing_17">#.HandleError.HandleError.Init &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Init</code>
<code> [1]  ⎕IO←1 ⋄ ⎕ML←1</code>
</div>
<code class="header" id="listing_18">#.HandleError.HandleError.MarkupAsTableRow &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> MarkupAsTableRow←{CR,'&lt</code>
</div>
<code class="header" id="listing_19">#.HandleError.HandleError.PrintErrorToSession &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> {r}←PrintErrorToSession msg</code>
<code> [1]  r←⍬</code>
<code> [2]  ⎕←'HandleError.Process caught ',msg</code>
</div>
<code class="header" id="listing_20">#.HandleError.HandleError.Public &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←Public</code>
<code> [1]  r←''</code>
<code> [2]  r,←⊂'CreateParms'</code>
<code> [3]  r,←⊂'History'</code>
<code> [4]  r,←⊂'Process'</code>
<code> [5]  r,←⊂'ReportErrorToWindowsLog'</code>
<code> [6]  r,←⊂'SetTrap'</code>
<code> [7]  r,←⊂'Version'</code>
</div>
<code class="header" id="listing_21">#.HandleError.HandleError.SaveVisibleVars &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> crash←SaveVisibleVars crash</code>
<code> [1]  rf←{⊃⍵~⊃⍵}⎕RSI</code>
<code> [2]  list←' '~¨⍨↓rf.⎕NL 2</code>
<code> [3]  'Vars'crash.⎕NS''</code>
<code> [4]  :For this :In list</code>
<code> [5]      ⍎'crash.Vars.',this,'←rf.⍎this'</code>
<code> [6]  :EndFor</code>
</div>
<code class="header" id="listing_22">#.HandleError.HandleError.SetTrap &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←{force}SetTrap parameterSpaceName</code>
<code> [1]  ⍝ Returns a vector useful to set `⎕TRAP`.</code>
<code> [2]  ⍝ It behaves differently depending on whether it's a development session or not.\\</code>
<code> [3]  ⍝ The right argument can be either an empty vector or the **name** of a parameter space - **not** a reference!\\</code>
<code> [4]  ⍝ The left argument defaults to 0. Setting this to 1 enforces error</code>
<code> [5]  ⍝ trapping even under a development exe. Useful for test cases.</code>
<code> [6]   ⎕TRAP←0⍴⎕TRAP</code>
<code> [7]   ⎕IO←1 ⋄ ⎕ML←0</code>
<code> [8]   force←{0=⎕NC ⍵:0 ⋄ ⍎⍵}'force'</code>
<code> [9]   r←(0 1000)'S'</code>
<code> [10]  calledFrom←{⌽{⍵/⍨2≤+\'.'=⍵}⌽⍵}1⊃⎕XSI</code>
<code> [11]  :If 0≠≢parameterSpaceName</code>
<code> [12]      :If 1≠≡,parameterSpaceName</code>
<code> [13]      :OrIf ~(⎕DR parameterSpaceName)∊80 82 160</code>
<code> [14]          'Invalid right argument: must be a name'⎕SIGNAL 11</code>
<code> [15]      :EndIf</code>
<code> [16]  :EndIf</code>
<code> [17]  :If 0=≢parameterSpaceName  ⍝ At a very early stage error trapping does not make sense</code>
<code> [18]  :AndIf (0=APLTreeUtils2.IsDevelopment)∨force</code>
<code> [19]      r←⊂0 'E'(calledFrom,'HandleError.Process ⍬')</code>
<code> [20]  :Else</code>
<code> [21]      :If (0=APLTreeUtils2.IsDevelopment)∨force</code>
<code> [22]          r←⊂0 'E'(calledFrom,'HandleError.Process ''',parameterSpaceName,'''')</code>
<code> [23]      :EndIf</code>
<code> [24]  :EndIf</code>
</div>
<code class="header" id="listing_23">#.HandleError.HandleError.WriteToWindowsEvents &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {r}←WriteToWindowsEvents parms</code>
<code> [1]   r←⍬</code>
<code> [2]   :If 'Win'≡APLTreeUtils2.GetOperatingSystem ⍬</code>
<code> [3]   :AndIf 0≠≢parms.windowsEventSource</code>
<code> [4]       :Trap (parms.trapInternalErrors)/0</code>
<code> [5]           msg←⊂'Application has crashed, RC=',(⍕crash.EN),'; MSG=',crash.EM</code>
<code> [6]           msg,←(0&lt;≢parms.errorFolder)/''('Details can be found in ',parms.errorFolder)</code>
<code> [7]           :If 0≠≢parms.addToMsg</code>
<code> [8]               msg,←{(≡⍵)∊0 1:,⊂,⍵ ⋄ ⍵}parms.addToMsg</code>
<code> [9]           :EndIf</code>
<code> [10]          ReportErrorToWindowsLog parms.windowsEventSource msg</code>
<code> [11]      :EndTrap</code>
<code> [12]  :EndIf</code>
</div>
<div id="footer">
<hr>
<p>Created by "CodeCoverage" version 0.10.7+52 from 2024-06-05</p>
</div>

</body>
</html>
